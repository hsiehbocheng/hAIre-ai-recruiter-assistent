<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>團隊資訊管理</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
      }

      iframe.sidebar {
        width: 200px;
        height: 100vh;
        border: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      table,
      th,
      td {
        border: 1px solid #ccc;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
      }

      th {
        background-color: #f4f4f4;
      }
    </style>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h2 class="mb-4">團隊資訊資管理</h2>
      <button
        type="button"
        class="btn btn-success mb-3"
        data-bs-toggle="modal"
        data-bs-target="#addUserModal"
      >
        新增
      </button>
      <table class="table table-striped table-bordered" id="myTable">
        <thead class="table-dark">
          <tr>
            <th>部</th>
            <th>科</th>
            <th scope="col">操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal 組件(新增) -->
    <div
      class="modal fade"
      id="addUserModal"
      tabindex="-1"
      aria-labelledby="addUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form>
            <div class="modal-header">
              <h5 class="modal-title" id="addUserModalLabel">新增</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="關閉"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="department" class="form-label">部</label>
                <input
                  type="text"
                  class="form-control"
                  id="department"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="division" class="form-label">科</label>
                <input
                  type="text"
                  class="form-control"
                  id="division"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="memberInfo" class="form-label"
                  >團隊與成員介紹</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="memberInfo"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="projectInfo" class="form-label">團隊專案資訊</label>
                <input
                  type="text"
                  class="form-control"
                  id="projectInfo"
                  required
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                取消
              </button>
              <button type="button" id="createTeam" class="btn btn-primary">
                儲存
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal 組件(編輯) -->
    <div
      class="modal fade"
      id="updateUserModal"
      tabindex="-1"
      aria-labelledby="updateUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form>
            <div class="modal-header">
              <h5 class="modal-title" id="updateUserModalLabel">編輯</h5>
              <input type="hidden" id="updateId" value="" />
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="關閉"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="updateDepartment" class="form-label">部</label>
                <input
                  type="text"
                  class="form-control"
                  id="updateDepartment"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="updateDivision" class="form-label">科</label>
                <input
                  type="text"
                  class="form-control"
                  id="updateDivision"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="updateMemberInfo" class="form-label"
                  >團隊與成員介紹</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="updateMemberInfo"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="updateProjectInfo" class="form-label"
                  >團隊專案資訊</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="updateProjectInfo"
                  required
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                取消
              </button>
              <button type="button" id="updateTeam" class="btn btn-primary">
                儲存
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      var dataList = {};
      document.addEventListener("DOMContentLoaded", function () {
        if (window.location.hash) {
          const hash = window.location.hash.substring(1);
          const params = new URLSearchParams(hash);
          const idToken = params.get("id_token");

          if (idToken) {
            localStorage.setItem("id_token", idToken);

            window.history.replaceState(null, "", window.location.pathname);
          }
        }
        fetchData();

        // 新增送出
        document
          .querySelector("#createTeam")
          .addEventListener("click", function (e) {
            const createData = {
              department: document.getElementById("department").value,
              division: document.getElementById("division").value,
              member_info: document.getElementById("memberInfo").value,
              project_info: document.getElementById("projectInfo").value,
            };
            console.log(createData);
            fetch(
              "https://m3jj8hrfhj.execute-api.ap-southeast-1.amazonaws.com/dev",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(createData),
              }
            ).then((res) => (res.ok ? location.reload() : alert("新增失敗")));
          });

        // 編輯送出
        document
          .querySelector("#updateTeam")
          .addEventListener("click", function (e) {
            const updateData = {
              team_id: document.getElementById("updateId").value,
              department: document.getElementById("updateDepartment").value,
              division: document.getElementById("updateDivision").value,
              member_info: document.getElementById("updateMemberInfo").value,
              project_info: document.getElementById("updateProjectInfo").value,
            };
            console.log(updateData);
            fetch(
              "https://m3jj8hrfhj.execute-api.ap-southeast-1.amazonaws.com/dev",
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(updateData),
              }
            ).then((res) => (res.ok ? location.reload() : alert("更新失敗")));
          });
      });

      // 查詢全部資料
      function fetchData() {
        fetch(
          "https://m3jj8hrfhj.execute-api.ap-southeast-1.amazonaws.com/dev",
          {
            method: "GET",
            headers: {
              Authorization: localStorage.getItem("id_token"),
              "Content-Type": "application/json",
            },
          }
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error("資料載入失敗");
            }
            return response.json();
          })
          .then((data) => {
            dataList = data;
            renderTable(data);
          })
          .catch((error) => {
            console.error("發生錯誤:", error);
          });
      }

      function renderTable(data) {
        const tableBody = document.querySelector("#myTable tbody");
        tableBody.innerHTML = ""; // 清空原本內容

        data.forEach((item) => {
          var objStr = JSON.stringify(item);
          const row = document.createElement("tr");
          row.innerHTML = `
        <td>${item.department}</td>
        <td>${item.division}</td>
        <td>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
          data-bs-target="#updateUserModal" data-id="${item.team_id}" >編輯</button>
                <button class="btn btn-danger btn-sm" data-id="${item.team_id}">刪除</button>
        </td>
      `;
          tableBody.appendChild(row);
        });

        // 動態元素，需要重新觸發
        // 當點擊到 "編輯" 按鈕時
        document
          .querySelector("#myTable .btn-primary")
          .addEventListener("click", function (e) {
            const id = e.target.dataset.id;
            showTeam(id);
          });
        document.querySelectorAll("#myTable .btn-primary").forEach((button) => {
          button.addEventListener("click", function (e) {
            const id = e.target.dataset.id;
            showTeam(id);
          });
        });

        // 刪除
        document.querySelectorAll(".btn-danger").forEach((btn) => {
          btn.addEventListener("click", function (e) {
            const id = e.target.dataset.id;

            console.log("你刪除的 ID:", id);

            fetch(
              `https://m3jj8hrfhj.execute-api.ap-southeast-1.amazonaws.com/dev?team_id=${encodeURIComponent(
                id
              )}`,
              {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                },
              }
            ).then((res) => (res.ok ? location.reload() : alert("刪除失敗")));
          });
        });
      }

      function showTeam(id) {
        console.log(id);
        fetch(
          `https://m3jj8hrfhj.execute-api.ap-southeast-1.amazonaws.com/dev?team_id=${encodeURIComponent(
            id
          )}`,
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          }
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error("資料載入失敗");
            }
            return response.json();
          })
          .then((data) => {
            document.getElementById("updateDepartment").value = data.department;
            document.getElementById("updateDivision").value = data.division;
            document.getElementById("updateMemberInfo").value =
              data.member_info;
            document.getElementById("updateProjectInfo").value =
              data.project_info;
            document.getElementById("updateId").value = data.team_id;
          })
          .catch((error) => {
            console.error("發生錯誤:", error);
          });
      }
    </script>
  </body>
</html>
