<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ˜éšŠç®¡ç† - hAIre æ‹›å‹Ÿç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- è¼‰å…¥é…ç½®æ–‡ä»¶ -->
    <script src="js/config.js"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header-section {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            text-decoration: none;
            transform: translateX(-3px);
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 600;
            margin: 0;
        }
        
        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-container {
            padding: 2rem;
        }
        
        .btn-add {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.4);
            color: white;
        }
        
        .table {
            margin-top: 1.5rem;
        }
        
        .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
        }
        
        .btn-action {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 6px;
            margin-right: 0.5rem;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }
        
        .modal-header .btn-close {
            filter: invert(1);
        }
        
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <div class="container">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                è¿”å›ä¸»é 
            </a>
            <h1 class="page-title">
                <i class="fas fa-users-cog me-3"></i>
                åœ˜éšŠç®¡ç†
            </h1>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="table-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">åœ˜éšŠåˆ—è¡¨</h2>
                    <button type="button" class="btn btn-add" data-bs-toggle="modal" data-bs-target="#addTeamModal">
                        <i class="fas fa-plus me-2"></i>æ–°å¢åœ˜éšŠ
                    </button>
                </div>
                
                <table class="table table-striped table-hover" id="teamsTable">
                    <thead>
                        <tr>
                            <th>å…¬å¸</th>
                            <th>éƒ¨é–€</th>
                            <th>åœ˜éšŠåç¨±</th>
                            <th>åœ˜éšŠæè¿°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- å‹•æ…‹è¼‰å…¥çš„åœ˜éšŠè³‡æ–™ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ–°å¢åœ˜éšŠ Modal -->
    <div class="modal fade" id="addTeamModal" tabindex="-1" aria-labelledby="addTeamModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTeamModalLabel">
                        <i class="fas fa-plus me-2"></i>æ–°å¢åœ˜éšŠ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
                </div>
                <div class="modal-body">
                    <form id="addTeamForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="company" class="form-label">å…¬å¸åç¨± *</label>
                                    <input type="text" class="form-control" id="company" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="companyCode" class="form-label">å…¬å¸ä»£ç¢¼ *</label>
                                    <input type="text" class="form-control" id="companyCode" required 
                                           placeholder="ä¾‹å¦‚ï¼šCXI, CATHAY, FUBON" maxlength="8" style="text-transform: uppercase;">
                                    <div class="form-text">2-8å€‹è‹±æ•¸å­—ï¼Œä¾‹å¦‚ï¼šCXIï¼ˆåœ‹æ³°ç”¢éšªï¼‰ã€CATHAYï¼ˆåœ‹æ³°é‡‘æ§ï¼‰</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="department" class="form-label">éƒ¨é–€åç¨± *</label>
                                    <input type="text" class="form-control" id="department" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="deptCode" class="form-label">éƒ¨é–€ä»£ç¢¼ *</label>
                                    <input type="text" class="form-control" id="deptCode" required 
                                           placeholder="ä¾‹å¦‚ï¼šDATAAI, IT, HR, FINANCE" maxlength="10" style="text-transform: uppercase;">
                                    <div class="form-text">2-10å€‹è‹±æ•¸å­—ï¼Œä¾‹å¦‚ï¼šDATAAIï¼ˆæ•¸æ“šAIéƒ¨ï¼‰ã€ITï¼ˆè³‡è¨Šéƒ¨ï¼‰</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="teamName" class="form-label">åœ˜éšŠ/ç§‘åˆ¥åç¨± *</label>
                                    <input type="text" class="form-control" id="teamName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="teamCode" class="form-label">ç§‘åˆ¥ä»£ç¢¼ *</label>
                                    <input type="text" class="form-control" id="teamCode" required 
                                           placeholder="ä¾‹å¦‚ï¼šCI, CT, DEV, QA" maxlength="8" style="text-transform: uppercase;">
                                    <div class="form-text">2-8å€‹è‹±æ•¸å­—ï¼Œä¾‹å¦‚ï¼šCIï¼ˆä¼æ¥­æ™ºèƒ½ç§‘ï¼‰ã€CTï¼ˆå®¢æˆ¶ç§‘æŠ€ç§‘ï¼‰</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="teamDescription" class="form-label">åœ˜éšŠæè¿°</label>
                            <textarea class="form-control" id="teamDescription" rows="3" 
                                      placeholder="ä¾‹å¦‚ï¼šè² è²¬ä¼æ¥­æ™ºèƒ½åŒ–å°ˆæ¡ˆé–‹ç™¼èˆ‡ç¶­é‹"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>åœ˜éšŠ ID é è¦½ï¼š</strong> <span id="teamIdPreview">è«‹å¡«å¯«å¿…è¦æ¬„ä½</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">åœ˜éšŠç›¸é—œæ–‡ä»¶ä¸Šå‚³ (å¯é¸)</label>
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <p class="mb-2">é»æ“Šæˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤è™•</p>
                                <p class="text-muted small">æ”¯æ´ TXT, JSON, CSV, PDF æ ¼å¼</p>
                                <input type="file" id="fileInput" multiple accept=".txt,.json,.csv,.pdf" style="display: none;">
                            </div>
                            <div id="fileList" class="mt-2"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" id="createTeam" class="btn btn-primary">å„²å­˜åœ˜éšŠ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯åœ˜éšŠ Modal -->
    <div class="modal fade" id="editTeamModal" tabindex="-1" aria-labelledby="editTeamModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTeamModalLabel">
                        <i class="fas fa-edit me-2"></i>ç·¨è¼¯åœ˜éšŠ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
                </div>
                <div class="modal-body">
                    <form id="editTeamForm">
                        <input type="hidden" id="editTeamId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCompany" class="form-label">å…¬å¸åç¨± *</label>
                                    <input type="text" class="form-control" id="editCompany" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCompanyCode" class="form-label">å…¬å¸ä»£ç¢¼ *</label>
                                    <input type="text" class="form-control" id="editCompanyCode" required 
                                           placeholder="ä¾‹å¦‚ï¼šCXI, CATHAY, FUBON" maxlength="8" style="text-transform: uppercase;">
                                    <div class="form-text">2-8å€‹è‹±æ•¸å­—ï¼Œä¾‹å¦‚ï¼šCXIï¼ˆåœ‹æ³°ç”¢éšªï¼‰ã€CATHAYï¼ˆåœ‹æ³°é‡‘æ§ï¼‰</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editDepartment" class="form-label">éƒ¨é–€åç¨± *</label>
                                    <input type="text" class="form-control" id="editDepartment" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editDeptCode" class="form-label">éƒ¨é–€ä»£ç¢¼ *</label>
                                    <input type="text" class="form-control" id="editDeptCode" required 
                                           placeholder="ä¾‹å¦‚ï¼šDATAAI, IT, HR, FINANCE" maxlength="10" style="text-transform: uppercase;">
                                    <div class="form-text">2-10å€‹è‹±æ•¸å­—ï¼Œä¾‹å¦‚ï¼šDATAAIï¼ˆæ•¸æ“šAIéƒ¨ï¼‰ã€ITï¼ˆè³‡è¨Šéƒ¨ï¼‰</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTeamName" class="form-label">åœ˜éšŠ/ç§‘åˆ¥åç¨± *</label>
                                    <input type="text" class="form-control" id="editTeamName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTeamCode" class="form-label">ç§‘åˆ¥ä»£ç¢¼ *</label>
                                    <input type="text" class="form-control" id="editTeamCode" required 
                                           placeholder="ä¾‹å¦‚ï¼šCI, CT, DEV, QA" maxlength="8" style="text-transform: uppercase;">
                                    <div class="form-text">2-8å€‹è‹±æ•¸å­—ï¼Œä¾‹å¦‚ï¼šCIï¼ˆä¼æ¥­æ™ºèƒ½ç§‘ï¼‰ã€CTï¼ˆå®¢æˆ¶ç§‘æŠ€ç§‘ï¼‰</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editTeamDescription" class="form-label">åœ˜éšŠæè¿°</label>
                            <textarea class="form-control" id="editTeamDescription" rows="3" 
                                      placeholder="ä¾‹å¦‚ï¼šè² è²¬ä¼æ¥­æ™ºèƒ½åŒ–å°ˆæ¡ˆé–‹ç™¼èˆ‡ç¶­é‹"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç¾æœ‰æ–‡ä»¶</label>
                            <div id="existingFiles" class="border rounded p-3 bg-light">
                                <!-- ç¾æœ‰æ–‡ä»¶åˆ—è¡¨ -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ä¸Šå‚³æ–°æ–‡ä»¶ (å¯é¸)</label>
                            <div class="upload-area" id="editUploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <p class="mb-2">é»æ“Šæˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤è™•</p>
                                <p class="text-muted small">æ”¯æ´ TXT, JSON, CSV, PDF æ ¼å¼</p>
                                <input type="file" id="editFileInput" multiple accept=".txt,.json,.csv,.pdf" style="display: none;">
                            </div>
                            <div id="editFileList" class="mt-2"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" id="updateTeam" class="btn btn-primary">æ›´æ–°åœ˜éšŠ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åœ˜éšŠè©³æƒ… Modal -->
    <div class="modal fade" id="teamDetailModal" tabindex="-1" aria-labelledby="teamDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="teamDetailModalLabel">
                        <i class="fas fa-info-circle me-2"></i>åœ˜éšŠè©³æƒ…
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
                </div>
                <div class="modal-body" id="teamDetailContent">
                    <!-- åœ˜éšŠè©³æƒ…å…§å®¹ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                    <button type="button" class="btn btn-primary" id="editFromDetail">ç·¨è¼¯åœ˜éšŠ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨åŸŸè®Šæ•¸
        let teamsData = [];
        let selectedFiles = [];
        let editSelectedFiles = [];

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            // æª¢æŸ¥é…ç½®
            if (window.CONFIG) {
                console.log('âœ… é…ç½®è¼‰å…¥æˆåŠŸ:', window.CONFIG);
            } else {
                console.error('âŒ é…ç½®è¼‰å…¥å¤±æ•—');
            }
            
            // è¼‰å…¥åœ˜éšŠè³‡æ–™
            fetchTeams();
            
            // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
            initializeEventListeners();
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
        function initializeEventListeners() {
            // æ–°å¢åœ˜éšŠæŒ‰éˆ•
            document.getElementById('createTeam').addEventListener('click', createTeam);
            
            // æ›´æ–°åœ˜éšŠæŒ‰éˆ•
            document.getElementById('updateTeam').addEventListener('click', updateTeam);
            
            // æ–‡ä»¶ä¸Šå‚³ç›¸é—œ
            setupFileUpload('uploadArea', 'fileInput', 'fileList', selectedFiles);
            setupFileUpload('editUploadArea', 'editFileInput', 'editFileList', editSelectedFiles);
            
            // å¾è©³æƒ…é ç·¨è¼¯
            document.getElementById('editFromDetail').addEventListener('click', function() {
                const teamId = this.getAttribute('data-team-id');
                showEditModal(teamId);
                bootstrap.Modal.getInstance(document.getElementById('teamDetailModal')).hide();
            });

            // æ–°å¢åœ˜éšŠ ID é è¦½åŠŸèƒ½
            const previewFields = ['companyCode', 'deptCode', 'teamCode'];
            previewFields.forEach(fieldId => {
                document.getElementById(fieldId).addEventListener('input', updateTeamIdPreview);
            });
        }

        // è¨­ç½®æ–‡ä»¶ä¸Šå‚³åŠŸèƒ½
        function setupFileUpload(areaId, inputId, listId, filesArray) {
            const uploadArea = document.getElementById(areaId);
            const fileInput = document.getElementById(inputId);
            const fileList = document.getElementById(listId);

            // é»æ“Šä¸Šå‚³å€åŸŸè§¸ç™¼æ–‡ä»¶é¸æ“‡
            uploadArea.addEventListener('click', () => fileInput.click());

            // æ–‡ä»¶é¸æ“‡äº‹ä»¶
            fileInput.addEventListener('change', function(e) {
                handleFiles(e.target.files, filesArray, fileList);
            });

            // æ‹–æ‹½äº‹ä»¶
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files, filesArray, fileList);
            });
        }

        // è™•ç†æ–‡ä»¶
        function handleFiles(files, filesArray, fileListElement) {
            for (let file of files) {
                if (isValidFileType(file)) {
                    filesArray.push(file);
                } else {
                    alert(`æª”æ¡ˆ ${file.name} æ ¼å¼ä¸æ”¯æ´ï¼Œåƒ…æ”¯æ´ TXT, JSON, CSV, PDF æ ¼å¼ã€‚`);
                }
            }
            renderFileList(filesArray, fileListElement);
        }

        // é©—è­‰æ–‡ä»¶é¡å‹
        function isValidFileType(file) {
            const allowedTypes = ['.txt', '.json', '.csv', '.pdf'];
            const fileName = file.name.toLowerCase();
            return allowedTypes.some(type => fileName.endsWith(type));
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList(filesArray, fileListElement) {
            fileListElement.innerHTML = '';
            filesArray.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'alert alert-info alert-dismissible fade show';
                fileItem.innerHTML = `
                    <i class="fas fa-file me-2"></i>${file.name}
                    <button type="button" class="btn-close" onclick="removeFile(${index}, '${fileListElement.id}')"></button>
                `;
                fileListElement.appendChild(fileItem);
            });
        }

        // ç§»é™¤æ–‡ä»¶
        function removeFile(index, listId) {
            if (listId === 'fileList') {
                selectedFiles.splice(index, 1);
                renderFileList(selectedFiles, document.getElementById('fileList'));
            } else if (listId === 'editFileList') {
                editSelectedFiles.splice(index, 1);
                renderFileList(editSelectedFiles, document.getElementById('editFileList'));
            }
        }

        // è¼‰å…¥åœ˜éšŠè³‡æ–™
        async function fetchTeams() {
            try {
                console.log('ğŸ”„ é–‹å§‹è¼‰å…¥åœ˜éšŠè³‡æ–™...');
                
                // ä½¿ç”¨é…ç½®ä¸­çš„ API URLï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨å¾Œå‚™ URL
                const apiUrl = window.CONFIG ? window.CONFIG.API_BASE_URL : 'https://m3jj8hrfhj.execute-api.ap-southeast-1.amazonaws.com/dev';
                console.log('ğŸ”— API URL:', apiUrl + '/teams');
                
                const response = await fetch(apiUrl + '/teams', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        // å¦‚æœéœ€è¦é©—è­‰ï¼ŒåŠ ä¸Š Authorization header
                        // 'Authorization': localStorage.getItem('id_token')
                    }
                });

                console.log('ğŸ“¡ API å›æ‡‰ç‹€æ…‹:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('âœ… åœ˜éšŠè³‡æ–™è¼‰å…¥æˆåŠŸ:', data);
                
                teamsData = data.teams || data; // è™•ç†å¯èƒ½çš„è³‡æ–™çµæ§‹å·®ç•°
                renderTeamsTable(teamsData);
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥åœ˜éšŠè³‡æ–™å¤±æ•—:', error);
                showAlert('è¼‰å…¥åœ˜éšŠè³‡æ–™å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // æ¸²æŸ“åœ˜éšŠè¡¨æ ¼
        function renderTeamsTable(teams) {
            const tbody = document.querySelector('#teamsTable tbody');
            tbody.innerHTML = '';

            if (!teams || teams.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                            å°šç„¡åœ˜éšŠè³‡æ–™
                        </td>
                    </tr>
                `;
                return;
            }

            teams.forEach(team => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${team.company || ''}</td>
                    <td>${team.department || ''}</td>
                    <td>${team.team_name || ''}</td>
                    <td>
                        <div class="text-truncate" style="max-width: 200px;" title="${team.team_description || ''}">
                            ${team.team_description || ''}
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-info btn-action btn-sm" onclick="showTeamDetail('${team.team_id}')">
                            <i class="fas fa-eye"></i> æª¢è¦–
                        </button>
                        <button class="btn btn-primary btn-action btn-sm" onclick="showEditModal('${team.team_id}')">
                            <i class="fas fa-edit"></i> ç·¨è¼¯
                        </button>
                        <button class="btn btn-danger btn-action btn-sm" onclick="deleteTeam('${team.team_id}')">
                            <i class="fas fa-trash"></i> åˆªé™¤
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ–°å¢åœ˜éšŠ
        async function createTeam() {
            try {
                const formData = {
                    company: document.getElementById('company').value.trim(),
                    company_code: document.getElementById('companyCode').value.trim().toUpperCase(),
                    department: document.getElementById('department').value.trim(),
                    dept_code: document.getElementById('deptCode').value.trim().toUpperCase(),
                    team_name: document.getElementById('teamName').value.trim(),
                    team_code: document.getElementById('teamCode').value.trim().toUpperCase(),
                    team_description: document.getElementById('teamDescription').value.trim()
                };

                // é©—è­‰å¿…å¡«æ¬„ä½
                if (!formData.company || !formData.company_code || !formData.department || 
                    !formData.dept_code || !formData.team_name || !formData.team_code) {
                    showAlert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'warning');
                    return;
                }

                console.log('ğŸ“¤ å»ºç«‹åœ˜éšŠè³‡æ–™:', formData);

                const apiUrl = window.CONFIG ? window.CONFIG.API_BASE_URL : 'https://m3jj8hrfhj.execute-api.ap-southeast-1.amazonaws.com/dev';
                
                const response = await fetch(apiUrl + '/teams', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorData}`);
                }

                const result = await response.json();
                console.log('âœ… åœ˜éšŠå»ºç«‹æˆåŠŸ:', result);

                // å¦‚æœæœ‰æ–‡ä»¶éœ€è¦ä¸Šå‚³
                if (selectedFiles.length > 0 && result.team_id) {
                    await uploadFiles(result.team_id, selectedFiles);
                }

                // é—œé–‰ modal ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™
                bootstrap.Modal.getInstance(document.getElementById('addTeamModal')).hide();
                resetAddForm();
                fetchTeams();
                showAlert('åœ˜éšŠå»ºç«‹æˆåŠŸï¼', 'success');

            } catch (error) {
                console.error('âŒ å»ºç«‹åœ˜éšŠå¤±æ•—:', error);
                showAlert('å»ºç«‹åœ˜éšŠå¤±æ•—: ' + error.message, 'danger');
            }
        }

        // é¡¯ç¤ºç·¨è¼¯ Modal
        function showEditModal(teamId) {
            const team = teamsData.find(t => t.team_id === teamId);
            if (!team) return;

            document.getElementById('editTeamId').value = team.team_id;
            document.getElementById('editCompany').value = team.company || '';
            document.getElementById('editCompanyCode').value = team.company_code || '';
            document.getElementById('editDepartment').value = team.department || '';
            document.getElementById('editDeptCode').value = team.dept_code || '';
            document.getElementById('editTeamName').value = team.team_name || '';
            document.getElementById('editTeamCode').value = team.team_code || '';
            document.getElementById('editTeamDescription').value = team.team_description || '';

            // æ¸…ç©ºç·¨è¼¯æ–‡ä»¶åˆ—è¡¨
            editSelectedFiles = [];
            renderFileList(editSelectedFiles, document.getElementById('editFileList'));

            // é¡¯ç¤ºç¾æœ‰æ–‡ä»¶ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            displayExistingFiles(team.team_id);

            new bootstrap.Modal(document.getElementById('editTeamModal')).show();
        }

        // æ›´æ–°åœ˜éšŠ
        async function updateTeam() {
            try {
                const teamId = document.getElementById('editTeamId').value;
                const formData = {
                    team_id: teamId,
                    company: document.getElementById('editCompany').value.trim(),
                    company_code: document.getElementById('editCompanyCode').value.trim().toUpperCase(),
                    department: document.getElementById('editDepartment').value.trim(),
                    dept_code: document.getElementById('editDeptCode').value.trim().toUpperCase(),
                    team_name: document.getElementById('editTeamName').value.trim(),
                    team_code: document.getElementById('editTeamCode').value.trim().toUpperCase(),
                    team_description: document.getElementById('editTeamDescription').value.trim()
                };

                // é©—è­‰å¿…å¡«æ¬„ä½
                if (!formData.company || !formData.company_code || !formData.department || 
                    !formData.dept_code || !formData.team_name || !formData.team_code) {
                    showAlert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'warning');
                    return;
                }

                console.log('ğŸ“¤ æ›´æ–°åœ˜éšŠè³‡æ–™:', formData);

                const apiUrl = window.CONFIG ? window.CONFIG.API_BASE_URL : 'https://m3jj8hrfhj.execute-api.ap-southeast-1.amazonaws.com/dev';
                
                const response = await fetch(apiUrl + '/teams/' + teamId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorData}`);
                }

                console.log('âœ… åœ˜éšŠæ›´æ–°æˆåŠŸ');

                // å¦‚æœæœ‰æ–°æ–‡ä»¶éœ€è¦ä¸Šå‚³
                if (editSelectedFiles.length > 0) {
                    await uploadFiles(teamId, editSelectedFiles);
                }

                // é—œé–‰ modal ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™
                bootstrap.Modal.getInstance(document.getElementById('editTeamModal')).hide();
                fetchTeams();
                showAlert('åœ˜éšŠæ›´æ–°æˆåŠŸï¼', 'success');

            } catch (error) {
                console.error('âŒ æ›´æ–°åœ˜éšŠå¤±æ•—:', error);
                showAlert('æ›´æ–°åœ˜éšŠå¤±æ•—: ' + error.message, 'danger');
            }
        }

        // åˆªé™¤åœ˜éšŠ
        async function deleteTeam(teamId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹åœ˜éšŠå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }

            try {
                console.log('ğŸ—‘ï¸ åˆªé™¤åœ˜éšŠ:', teamId);

                const apiUrl = window.CONFIG ? window.CONFIG.API_BASE_URL : 'https://m3jj8hrfhj.execute-api.ap-southeast-1.amazonaws.com/dev';
                
                const response = await fetch(`${apiUrl}/teams/${encodeURIComponent(teamId)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorData}`);
                }

                console.log('âœ… åœ˜éšŠåˆªé™¤æˆåŠŸ');
                fetchTeams();
                showAlert('åœ˜éšŠåˆªé™¤æˆåŠŸï¼', 'success');

            } catch (error) {
                console.error('âŒ åˆªé™¤åœ˜éšŠå¤±æ•—:', error);
                showAlert('åˆªé™¤åœ˜éšŠå¤±æ•—: ' + error.message, 'danger');
            }
        }

        // é¡¯ç¤ºåœ˜éšŠè©³æƒ…
        function showTeamDetail(teamId) {
            const team = teamsData.find(t => t.team_id === teamId);
            if (!team) return;

            const content = document.getElementById('teamDetailContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-building me-2"></i>å…¬å¸</h6>
                        <p class="border-bottom pb-2">${team.company || 'æœªè¨­å®š'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-building me-2"></i>éƒ¨é–€</h6>
                        <p class="border-bottom pb-2">${team.department || 'æœªè¨­å®š'}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-users me-2"></i>åœ˜éšŠåç¨±</h6>
                        <p class="border-bottom pb-2">${team.team_name || 'æœªè¨­å®š'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-code me-2"></i>åœ˜éšŠä»£ç¢¼</h6>
                        <p class="border-bottom pb-2">${team.company_code}-${team.dept_code}-${team.team_code}</p>
                    </div>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-info-circle me-2"></i>åœ˜éšŠæè¿°</h6>
                    <p class="border-bottom pb-2">${team.team_description || 'æœªè¨­å®š'}</p>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-file me-2"></i>ç›¸é—œæ–‡ä»¶</h6>
                    <div id="teamFiles" class="border rounded p-3 bg-light">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
                <div class="text-muted small">
                    <p><strong>åœ˜éšŠ ID:</strong> ${team.team_id}</p>
                    <p><strong>å»ºç«‹æ™‚é–“:</strong> ${team.created_at || 'æœªçŸ¥'}</p>
                    <p><strong>æœ€å¾Œæ›´æ–°:</strong> ${team.updated_at || 'æœªçŸ¥'}</p>
                </div>
            `;

            // è¨­ç½®ç·¨è¼¯æŒ‰éˆ•çš„ team_id
            document.getElementById('editFromDetail').setAttribute('data-team-id', teamId);

            // è¼‰å…¥æ–‡ä»¶åˆ—è¡¨
            loadTeamFiles(teamId);

            new bootstrap.Modal(document.getElementById('teamDetailModal')).show();
        }

        // è¼‰å…¥åœ˜éšŠæ–‡ä»¶
        async function loadTeamFiles(teamId) {
            const filesContainer = document.getElementById('teamFiles');
            try {
                // é€™è£¡æ‡‰è©²å‘¼å« S3 API ä¾†å–å¾—æ–‡ä»¶åˆ—è¡¨
                // æš«æ™‚é¡¯ç¤ºä½”ä½ç¬¦
                filesContainer.innerHTML = '<p class="text-muted">æ–‡ä»¶åŠŸèƒ½é–‹ç™¼ä¸­...</p>';
            } catch (error) {
                filesContainer.innerHTML = '<p class="text-danger">è¼‰å…¥æ–‡ä»¶å¤±æ•—</p>';
            }
        }

        // é¡¯ç¤ºç¾æœ‰æ–‡ä»¶
        function displayExistingFiles(teamId) {
            const container = document.getElementById('existingFiles');
            // é€™è£¡æ‡‰è©²å¾ S3 å–å¾—ç¾æœ‰æ–‡ä»¶åˆ—è¡¨
            container.innerHTML = '<p class="text-muted">æ–‡ä»¶åŠŸèƒ½é–‹ç™¼ä¸­...</p>';
        }

        // ä¸Šå‚³æ–‡ä»¶åˆ° S3
        async function uploadFiles(teamId, files) {
            console.log('ğŸ“ æº–å‚™ä¸Šå‚³æ–‡ä»¶:', files.length, 'å€‹æ–‡ä»¶åˆ°åœ˜éšŠ:', teamId);
            // é€™è£¡éœ€è¦å¯¦ä½œ S3 ä¸Šå‚³é‚è¼¯
            // æš«æ™‚è·³éæ–‡ä»¶ä¸Šå‚³
        }

        // é‡ç½®æ–°å¢è¡¨å–®
        function resetAddForm() {
            document.getElementById('addTeamForm').reset();
            selectedFiles = [];
            renderFileList(selectedFiles, document.getElementById('fileList'));
        }

        // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
        function showAlert(message, type = 'info') {
            // ç§»é™¤ç¾æœ‰çš„ alert
            const existingAlert = document.querySelector('.alert-dismissible');
            if (existingAlert) {
                existingAlert.remove();
            }

            // å»ºç«‹æ–°çš„ alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // 3ç§’å¾Œè‡ªå‹•é—œé–‰
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // æ›´æ–°åœ˜éšŠ ID é è¦½
        function updateTeamIdPreview() {
            const companyCode = document.getElementById('companyCode').value.trim().toUpperCase();
            const deptCode = document.getElementById('deptCode').value.trim().toUpperCase();
            const teamCode = document.getElementById('teamCode').value.trim().toUpperCase();
            
            const previewElement = document.getElementById('teamIdPreview');
            
            if (companyCode && deptCode && teamCode) {
                // ç”Ÿæˆæ™‚é–“æˆ³ (MMDDHHSS æ ¼å¼)
                const now = new Date();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                const timestamp = `${month}${day}${hour}${minute}`;
                
                const teamId = `${companyCode}-${deptCode}-${teamCode}-${timestamp}`;
                previewElement.innerHTML = `<code>${teamId}</code>`;
                previewElement.className = 'text-success';
            } else {
                previewElement.textContent = 'è«‹å¡«å¯«å¿…è¦æ¬„ä½';
                previewElement.className = 'text-muted';
            }
        }
    </script>
</body>
</html>

